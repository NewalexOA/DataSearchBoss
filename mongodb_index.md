# Документация модуля MongoDBIndex

## Обзор

Модуль `mongodb_index.py` предоставляет интерфейс для работы с векторами в базе данных MongoDB. Он позволяет добавлять, удалять, обновлять и искать векторы в MongoDB, а также сохранять и загружать индекс из файла.

## Класс: `MongoDBIndex`

### Инициализация

#### `__init__(self, db_name, collection_name, dimension)`

Инициализирует индекс MongoDB.

- **Параметры:**
  - `db_name` (str): Название базы данных.
  - `collection_name` (str): Название коллекции.
  - `dimension` (int): Размерность векторов.

- **Исключения:**
  - `errors.ServerSelectionTimeoutError`: Ошибка подключения к MongoDB.
  - `errors.CollectionInvalid`: Ошибка создания коллекции.

### Методы

---

#### `add_vectors(self, vectors, ids)`

Добавляет новые вектора в индекс.

- **Параметры:**
  - `vectors` (numpy.ndarray): Вектора для добавления. Размерность (n, d), где n - количество векторов, d - размерность.
  - `ids` (list): Список уникальных идентификаторов (URL видео).

- **Исключения:**
  - `ValueError`: Если количество векторов не соответствует количеству идентификаторов.
  - `errors.DuplicateKeyError`: Если идентификатор уже существует в базе данных.
  - `errors.PyMongoError`: Любая другая ошибка, связанная с PyMongo.

##### Пояснение:
Этот метод добавляет вектора в индекс, связывая их с уникальными идентификаторами (URL видео).

---

#### `remove_vectors(self, ids)`

Удаляет вектора по их идентификаторам.

- **Параметры:**
  - `ids` (list): Идентификаторы векторов для удаления.

- **Исключения:**
  - `errors.PyMongoError`: Любая ошибка, связанная с PyMongo.

##### Пояснение:
Этот метод удаляет вектора из индекса по их идентификаторам.

---

#### `update_vectors(self, ids, new_vectors)`

Обновляет существующие вектора.

- **Параметры:**
  - `ids` (list): Идентификаторы векторов для обновления.
  - `new_vectors` (numpy.ndarray): Новые значения векторов. Размерность (n, d), где n - количество векторов, d - размерность.

- **Исключения:**
  - `ValueError`: Если количество векторов не соответствует количеству идентификаторов.
  - `errors.PyMongoError`: Любая ошибка, связанная с PyMongo.

##### Пояснение:
Этот метод обновляет существующие вектора новыми значениями. Сначала удаляются старые вектора по указанным идентификаторам, затем добавляются новые вектора.

---

#### `search_vectors(self, query_vectors, k)`

Ищет ближайших соседей для заданных запросных векторов.

- **Параметры:**
  - `query_vectors` (numpy.ndarray): Вектора для поиска. Размерность (m, d), где m - количество запросных векторов, d - размерность.
  - `k` (int): Количество ближайших соседей для поиска.

- **Возвращает:**
  - `neighbors` (list): Список ближайших соседей. Каждый элемент списка - это список кортежей (идентификатор, расстояние). Количество ближайших соседей соответствует значению параметра `k`.

- **Исключения:**
  - `errors.PyMongoError`: Любая ошибка, связанная с PyMongo.

##### Пояснение:
Этот метод выполняет поиск ближайших соседей для заданных запросных векторов. Возвращает список ближайших соседей, где каждый элемент - это список кортежей (идентификатор, расстояние). Количество ближайших соседей в каждом списке соответствует значению параметра `k`.

#### Пример структуры возвращаемого результата

```python
[
    [
        ("id_1", 0.5),
        ("id_2", 0.7),
        ("id_3", 1.2)
    ],
    [
        ("id_4", 0.3),
        ("id_5", 0.6),
        ("id_6", 1.1)
    ]
]
```
---

#### `save_index(self, file_path)`

Сохраняет индекс в файл.

- **Параметры:**
  - `file_path` (str): Путь к файлу для сохранения.

- **Исключения:**
  - `OSError`: Ошибка при сохранении файла.
  - `pickle.PickleError`: Ошибка при сериализации данных.

##### Пояснение:
Этот метод сохраняет текущий индекс в указанный файл. Это позволяет сохранить состояние индекса для последующего использования.

---

#### `load_index(self, file_path)`

Загружает индекс из файла.

- **Параметры:**
  - `file_path` (str): Путь к файлу.

- **Исключения:**
  - `OSError`: Ошибка при загрузке файла.
  - `pickle.PickleError`: Ошибка при десериализации данных.
  - `errors.BulkWriteError`: Ошибка при массовой вставке данных в MongoDB.
  - `errors.PyMongoError`: Любая другая ошибка, связанная с PyMongo.

##### Пояснение:
Этот метод загружает индекс из указанного файла. Это позволяет восстановить состояние индекса из ранее сохраненного файла.

---

#### `get_total_vectors(self)`

Возвращает общее количество векторов в индексе.

- **Возвращает:**
  - `int`: Количество векторов в индексе.

- **Исключения:**
  - `errors.PyMongoError`: Любая ошибка, связанная с PyMongo.

##### Пояснение:
Этот метод возвращает общее количество векторов, хранящихся в индексе.
